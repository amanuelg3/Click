if(!dojo._hasResource["bidi.DojoEditorBidi"]){dojo._hasResource["bidi.DojoEditorBidi"]=true;define(["dojo/_base/declare","dijit/_editor/RichText","dijit/Editor","dijit/_WidgetBase"],function(_1,_2){_1("bidi/DojoEditorBidi",[_2],{postCreate:function(){this.inherited(arguments);this.isVisualMode=false;this.isTextReversed=false;this.dir="ltr";this._savedPushBoundaries=null;this._selectionLength=0;if(this.isTextReversed){var _3=this;require(["dojo/_base/xhr","dojo/_base/lang"],function(_4,_5){var _6=_5.hitch(_3,"_reverseNodes");_3.contentDomPreFilters.push(_6);_3.contentDomPostFilters.push(_6);});}},_adjustCursorOnPushTyping:function(_7){try{if(dojo.isIE){var b=dojo.withGlobal(this.window,dijit.getBookmark);var _8=dijit.range.getSelection(this.window);if(b&&b.mark&&!dojo.isArray(b.mark)&&_8){if(_8.rangeCount){range=_8.getRangeAt(0);}if(range){b.mark=range.cloneRange();}else{b.mark=dojo.withGlobal(this.window,dijit.getBookmark);}if(_8.removeAllRanges){_8.removeAllRanges();r=dijit.range.create(this.window);var _9=dijit.range.getIndex(b.mark.startContainer,this.editNode).o;node=dijit.range.getNode(_9,this.editNode);if(_7==null){_7=b.mark.startOffset-1;}if(node){r.setStart(node,_7);r.setEnd(node,_7);_8.addRange(r);}}}}else{if(dojo.global.getSelection){var _8=dojo.global.getSelection();if(_8.removeAllRanges){var _a=_8.getRangeAt(0);if(_7==null){_7=_a.startOffset-1;}_a.setStart(_a.startContainer,_7);_a.setEnd(_a.endContainer,_7);_8.removeAllRanges();_8.addRange(_a);}}}}catch(e){}},_getCursorPos:function(){var _b=null;try{if(dojo.isIE){var b=dojo.withGlobal(this.window,dijit.getBookmark);var _c=dijit.range.getSelection(this.window);if(b&&b.mark&&!dojo.isArray(b.mark)&&_c){if(_c.rangeCount){range=_c.getRangeAt(0);}if(range){b.mark=range.cloneRange();}else{b.mark=dojo.withGlobal(this.window,dijit.getBookmark);}if(b.mark){var _d=dijit.range.getIndex(b.mark.startContainer,this.editNode).o;node=dijit.range.getNode(_d,this.editNode);if(node){_b={container:node,leftBound:b.mark.startOffset,rightBound:b.mark.endOffset};}}}}else{if(dojo.global.getSelection){var _c=dojo.global.getSelection();if(_c){var _e=_c.getRangeAt(0);if(_e){_b={container:_e.startContainer,leftBound:_e.startOffset,rightBound:_e.endOffset};}}}}}catch(e){}return _b;},onKeyPress:function(e){if(this.isVisualMode){try{var _f=(dojo.isIE)?e.keyCode:e.charCode;this._isKeyboardLayerRtl=null;this._isKeyUpDone=false;if(((_f>64)&&(_f<91))||((_f>96)&&(_f<123))){this._isKeyboardLayerRtl=false;}else{if((_f>1487)&&!((_f>1631)&&(_f<1642))){this._isKeyboardLayerRtl=true;}else{if((_f!=32)&&this._isKeyboardLayerRtl&&(((_f>47)&&(_f<58))||((_f>1631)&&(_f<1642)))){this._isKeyboardLayerRtl=false;}}}var _10=dojo.withGlobal(this.window,"_getCursorPos",this,[]);if(this._isKeyboardLayerRtl!=null){if((this._isKeyboardLayerRtl!=(this.dir.toLowerCase()=="rtl"))&&(this._savedPushBoundaries==null)){this._savedPushBoundaries=_10;}if(this._isKeyboardLayerRtl==(this.dir.toLowerCase()=="rtl")){if((this._savedPushBoundaries!=null)&&(_10.leftBound==this._savedPushBoundaries.leftBound)){var _11=(this._savedPushBoundaries.rightBound)?this._savedPushBoundaries.rightBound:null;dojo.withGlobal(this.window,"_adjustCursorOnPushTyping",this,[_11]);}this._savedPushBoundaries=null;}}if(this._isKeyboardLayerRtl!=null){if(_10&&(_10.rightBound!=undefined)){this._selectionLength=Math.abs(_10.rightBound-_10.leftBound);}else{this._selectionLength=0;}}if(this._isOverWriteMode()&&(this._isKeyboardLayerRtl!=null)&&((this.dir.toLowerCase()=="rtl")!=this._isKeyboardLayerRtl)){dojo.withGlobal(this.window,"_adjustCursorOnPushTyping",this,[null]);}}catch(e){}}this.inherited(arguments);},onKeyUp:function(e){this.inherited(arguments);if(!this.isVisualMode){return;}try{if(!this._isKeyUpDone&&(this._isKeyboardLayerRtl!=null)&&!e.ctrlKey&&((this.dir.toLowerCase()=="rtl")!=this._isKeyboardLayerRtl)){dojo.withGlobal(this.window,"_adjustCursorOnPushTyping",this,[null]);if(this._savedPushBoundaries!=null){if(this._isOverWriteMode()){var _12=dojo.withGlobal(this.window,"_getCursorPos",this,[]);if(this._savedPushBoundaries.leftBound>0&&(this._savedPushBoundaries.leftBound>_12.leftBound)){this._savedPushBoundaries.leftBound-=1;}}else{this._savedPushBoundaries.rightBound+=(this._selectionLength!=0)?(1-this._selectionLength):1;}}}this._isKeyUpDone=true;var key=e.keyCode,ks=dojo.keys;switch(key){case ks.LEFT_ARROW:case ks.RIGHT_ARROW:if(this._savedPushBoundaries!=null){var _13=dojo.withGlobal(this.window,"_getCursorPos",this,[]);if((_13==null)||(_13.container!=this._savedPushBoundaries.container)||(_13.rightBound>this._savedPushBoundaries.rightBound)||(_13.leftBound<this._savedPushBoundaries.leftBound)){this._savedPushBoundaries=null;}}break;case ks.UP_ARROW:case ks.DOWN_ARROW:if(this._savedPushBoundaries!=null){var _13=dojo.withGlobal(this.window,"_getCursorPos",this,[]);if((_13==null)||(_13.container!=this._savedPushBoundaries.container)){this._savedPushBoundaries=null;}}break;case ks.HOME:case ks.END:case ks.PAGE_UP:case ks.PAGE_DOWN:case ks.ENTER:this._savedPushBoundaries=null;break;}}catch(e){}},onKeyDown:function(e){if(dojo.isIE&&(65<=e.keyCode&&e.keyCode<=90)){return;}var key=e.keyCode,ks=dojo.keys;if(this.isVisualMode&&(key==ks.BACKSPACE||key==ks.DELETE)&&(this._savedPushBoundaries!=null)){if(this._savedPushBoundaries.leftBound==this._savedPushBoundaries.rightBound){this._savedPushBoundaries=null;}if(this._savedPushBoundaries!=null){var _14=dojo.withGlobal(this.window,"_getCursorPos",this,[]);if((_14!=null)&&(_14.rightBound!=undefined)){this._selectionLength=Math.abs(_14.rightBound-_14.leftBound);}else{this._selectionLength=0;}if((this._savedPushBoundaries.leftBound>0)&&(this._savedPushBoundaries.rightBound>0)){if((key==ks.BACKSPACE)&&(this._selectionLength==0)&&(this._savedPushBoundaries.leftBound==_14.leftBound)){this._savedPushBoundaries.leftBound-=1;}this._savedPushBoundaries.rightBound-=(this._selectionLength!=0)?(this._selectionLength):1;}else{if(this._selectionLength>0){var _15=Math.abs(this._savedPushBoundaries.rightBound-this._savedPushBoundaries.leftBound);if(this._selectionLength>=_15){this._savedPushBoundaries=null;}}}}}this.inherited(arguments);if((key==dojo.keys.SHIFT)&&e.ctrlKey){this.dir=((this.dir.toLowerCase()=="rtl")?"ltr":"rtl");if(this.focusNode.style.direction!=this.dir){this.focusNode.style.direction=this.dir;this._savedPushBoundaries=null;}}},_onMouseUp:function(e){if((this._savedPushBoundaries!=null)&&(this._savedPushBoundaries.leftBound>0)&&(this._savedPushBoundaries.rightBound>0)){var _16=dojo.withGlobal(this.window,"_getCursorPos",this,[]);if((_16==null)||(_16.container!=this._savedPushBoundaries.container)||(_16.rightBound>this._savedPushBoundaries.rightBound)||(_16.leftBound<this._savedPushBoundaries.leftBound)){this._savedPushBoundaries=null;}}this.inherited(arguments);},_onPaste:function(e){this._savedPushBoundaries=null;},_onCut:function(e){if(this._savedPushBoundaries!=null){var _17=dojo.withGlobal(this.window,"_getCursorPos",this,[]);if((_17!=null)&&(_17.rightBound!=undefined)){this._selectionLength=Math.abs(_17.rightBound-_17.leftBound);}else{this._selectionLength=0;}if(this._selectionLength>0){if((this._savedPushBoundaries.leftBound<_17.leftBound)&&(this._savedPushBoundaries.rightBound>_17.rightBound)){this._savedPushBoundaries.rightBound-=(this._selectionLength);}else{this._savedPushBoundaries=null;}}}},_onBlur:function(e){this.inherited(arguments);if(this.isVisualMode){this._savedPushBoundaries=null;}},onLoad:function(_18){this.inherited(arguments);if(this.isVisualMode){this.editNode.style.unicodeBidi="bidi-override";this.connect(this.editNode,"onmouseup",this._onMouseUp);this.connect(this.editNode,"oncut",this._onCut);this.connect(this.editNode,"onpaste",this._onPaste);if(this.document.createStyleSheet){var _19=this.document.styleSheets[this.document.styleSheets.length-1];_19.addRule("p","{unicode-bidi: bidi-override}");_19.addRule("li","{unicode-bidi: bidi-override}");_19.addRule("div","{unicode-bidi: bidi-override}");_19.addRule("blockquote","{unicode-bidi: bidi-override}");}else{if(dojo.isMoz){this.document.styleSheets[0].insertRule("div,ul>li,ol>li,blockquote {unicode-bidi: bidi-override}",0);}}}},_doSymSwap:function(_1a){switch(_1a){case "(":_1a=")";break;case ")":_1a="(";break;case "{":_1a="}";break;case "}":_1a="{";break;case "[":_1a="]";break;case "]":_1a="[";break;case "<":_1a=">";break;case ">":_1a="<";break;}return _1a;},_reverseText:function(_1b){var len=_1b.length;if(len<2){return _1b;}var ret="";for(var i=0;i<len;i++){ret+=this._doSymSwap(_1b.charAt(len-i-1));}return ret;},_reverseNodes:function(_1c){try{var len=_1c.childNodes.length;if(len>0){for(var i=0;i<len;i++){this._reverseNodes(_1c.childNodes[i]);}}else{if(_1c.nodeType==1){tagName=_1c.tagName.toLowerCase();if((tagName!="style")&&(tagName!="script")&&(tagName!="br")){_1c.innerHTML=this._reverseText(_1c.innerHTML);}}else{if(_1c.nodeType==3){_1c.nodeValue=this._reverseText(_1c.nodeValue);}}}}catch(e){}return _1c;},_isOverWriteMode:function(){return ((dojo.isIE)?document.queryCommandValue("OverWrite"):false);}});});}